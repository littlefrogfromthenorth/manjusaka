var z=Math.pow;var V=(e,a,f)=>new Promise((n,r)=>{var b=s=>{try{l(f.next(s))}catch(m){r(m)}},d=s=>{try{l(f.throw(s))}catch(m){r(m)}},l=s=>s.done?n(s.value):Promise.resolve(s.value).then(b,d);l((f=f.apply(e,a)).next())});import{a as G}from"./index.7c437fb2.js";import{b8 as re,r as N,a as M,dc as ie,b as O,aQ as I,aR as E,o as k,i as U,j as p,k as i,aT as le,cj as T,dY as de,dM as Q,f as Y,bu as ce,e6 as pe,am as J,a2 as fe,aa as X,e7 as j,z as S,l as R,W as H,m as B,C as _,t as me,q as ge,b0 as Fe,c as Ee,bR as be,s as Ce,e8 as ve}from"./index.ecaec58b.js";import{T as K}from"./index.27c0b081.js";import{B as Z,u as Be,U as De,j as we}from"./useForm.77c27927.js";import{n as F}from"./nps.6de071b3.js";import{x as q,a as L}from"./addon-fit.5989f935.js";import{I as Ae}from"./index.d2065cf3.js";import{T as ye}from"./index.502108af.js";import{D as he}from"./index.292bc1f2.js";import{B as ke,u as Pe,a as $e}from"./index.e472a703.js";import{a as Me}from"./download.0a6ebd5a.js";import{R as Te}from"./RoleModal.1ba89c9f.js";import"./index.81d2e3e6.js";import"./index.9c3be20b.js";import"./useSize.37dbc3ba.js";import"./useContentViewHeight.33e9d1e7.js";import"./ArrowLeftOutlined.68372d7a.js";import"./FullscreenOutlined.fdf277a8.js";import"./_baseIteratee.95e39a32.js";import"./index.5adf4b72.js";import"./index.66a07c9f.js";import"./isEqual.07d69833.js";import"./index.42eff1d5.js";import"./index.c74c0e50.js";import"./index.84bf6fd3.js";function Se(e){if(!re())throw new Error("useDescription() can only be used inside setup() or functional components!");const a=N(null),f=N(!1);function n(b){M(f)&&ie()||(a.value=b,e&&b.setDescProps(e),f.value=!0)}return[n,{setDescProps:b=>{var d;(d=M(a))==null||d.setDescProps(b)}}]}const Re=O({name:"PlugModal",components:{BasicModal:ke,BasicForm:Z},emits:["success"],setup(e,a){const[f,{setFieldsValue:n,getFieldsValue:r}]=Be({labelWidth:100,schemas:[{required:!0,field:"name",component:"ApiSelect",label:"\u63D2\u4EF6\u540D\u79F0",componentProps:{api:T,params:{action:"pluglist"},labelField:"name",valueField:"name",resultField:"items",onChange:(s,m)=>{n(m)}}},{field:"entry",component:"Input",label:"\u5165\u53E3\u70B9"},{field:"args",component:"InputTextArea",label:"\u8FD0\u884C\u53C2\u6570",componentProps:{autoSize:!0}}],showResetButton:!1,showSubmitButton:!1}),b=Pe(s=>V(this,null,function*(){n(s)}));function d(s){return s.includes(".")?s.split(".").pop().toLowerCase():""}function l(){let s=r(),m=F.AgentEvent.create(),g=F.Plugin.create();g.act="ex",g.name=s.name.split(".")[0],g.entry=s.entry,g.args=s.args,g.arch=d(s.name),m.plugin=g,a.emit("success",m)}return{registerModal:b,registerForm:f,handleSubmit:l}}});function _e(e,a,f,n,r,b){const d=E("BasicForm"),l=E("BasicModal");return k(),U(l,le(e.$attrs,{width:600,onRegister:e.registerModal,title:"\u8FD0\u884C\u63D2\u4EF6",okText:"\u4E0B\u53D1\u6307\u4EE4",onOk:e.handleSubmit}),{default:p(()=>[i(d,{onRegister:e.registerForm},null,8,["onRegister"])]),_:1},16,["onRegister","onOk"])}var Ne=I(Re,[["render",_e]]);const Oe=O({name:"AgentInfo",components:{PageWrapper:G,CollapseContainer:de,BasicForm:Z,Description:he,InputNumber:Ae,Upload:De,PopConfirmButton:Q,Time:ye,Terminal:q.exports.Terminal,FitAddon:L.exports.FitAddon,ProxyModal:Te,PlugModal:Ne},props:["agent","event"],emits:["onsend"],setup(e,{emit:a}){const f=N(null),n=Y({agent:{},cmd:"",pwd:"",history:[],crtlist:[]}),r=ce(),[b,{openModal:d,closeModal:l}]=$e(),{createMessage:s}=ge(),[m]=Se({column:2,schema:[{field:"id",label:"NPCID"},{field:"pid",label:"PID"},{field:"platform",label:"\u7CFB\u7EDF"},{field:"arch",label:"\u6784\u67B6"},{field:"hostname",label:"\u4E3B\u673A\u540D"},{field:"intranet",label:"\u5185\u7F51\u5730\u5740"},{field:"username",label:"\u7528\u6237\u540D"},{field:"internet",label:"\u516C\u7F51\u5730\u5740"},{field:"target",label:"\u8DEF\u7531"},{field:"note",label:"\u5907\u6CE8"},{field:"ntype",label:"NPC\u7C7B\u578B"},{field:"updateat",label:"\u6700\u540E\u56DE\u8FDE",render:(t,o)=>j(o.updateat*1e3)},{field:"process",label:"\u8FDB\u7A0B\u8DEF\u5F84"}]}),g=new L.exports.FitAddon,u=new q.exports.Terminal({fontSize:15,fontWeight:"normal",fontFamily:"Consolas",rendererType:"canvas",cursorBlink:!1,disableStdin:!1,allowProposedApi:!0,fastScrollModifier:"ctrl",scrollback:1e6,theme:{background:"#002833",cursor:"#268F81"}});u.onKey(t=>{if((t.domEvent.ctrlKey||t.domEvent.metaKey)&&(t.domEvent.preventDefault(),t.domEvent.key==="c"&&pe(u.getSelection()),t.domEvent.key==="s")){const o=u.buffer.active;let C="";for(let v=0;v<o.length;v++){const h=o.getLine(v);h&&(C+=h.translateToString(!0)+`
`)}Me(C,n.agent.intranet+".log")}});const A=t=>{const o=["Bytes","KB","MB","GB","TB"];if(t==0)return"-";const C=Math.floor(Math.log(t)/Math.log(1024)),v=(t/z(1024,C)).toFixed(0);return C===0?"1 KB":`${v} ${o[C]}`},c=t=>new TextDecoder().decode(t).replace(/\r\n|\r|\n/g,`\r
`);function y(){let t=F.Action.create();t.act="cr";let o=F.AgentEvent.create();o.action=t,a("onsend",o),s.success("\u622A\u5C4F\u547D\u4EE4\u5DF2\u53D1\u9001\uFF01 \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002")}function D(){let t=F.Config.create();t.action=2;let o=F.AgentEvent.create();o.conf=t,a("onsend",o),s.success("NPC\u9500\u6BC1\u547D\u4EE4\u53D1\u9001")}function $(t){r("/agentcmd/"+t)}function P(t){r("/agentfile/"+t)}function x(t){r("/agentvnc/"+t)}function ee(t){r("/agentrdp/"+t)}function te(){if(n.agent.npc2)T({action:"npc2stop",data:{id:n.agent.id}}).then(t=>{n.agent.npc2=!1}).catch(t=>{});else{let t=F.Plugin.create();t.act="ex",t.name="npc2";let o=F.AgentEvent.create();o.plugin=t,a("onsend",o),s.success("NPC2\u52A0\u8F7D\u4E2D\u3002\u3002\u3002 \u8BF7\u7B49\u5F85\u8FD4\u56DE\uFF01")}}function ne(){d(!0,{record:{id:n.agent.id}})}function ae(){d(!0,{record:{id:n.agent.id}})}function ue(t){a("onsend",t),l()}const oe=t=>{const o=new FileReader;return o.readAsArrayBuffer(t),o.onload=C=>{var v;if(((v=C.target)==null?void 0:v.result)instanceof ArrayBuffer){const h=new Uint8Array(C.target.result);let w=F.Action.create();w.act="fw",w.path=t.name,w.data=h;let W=F.AgentEvent.create();W.action=w,a("onsend",W),s.success(`\u6587\u4EF6:${t.name} \u5927\u5C0F:${A(t.size)} \u4E0A\u4F20\u4E2D... \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002`)}},o.onerror=()=>{s.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},!1};function se(){let t=n.cmd.split(" "),o=F.Action.create();switch(F.Entry.create(),t[0]){case"ss":o.act="ss";break;case"ps":o.act="ps";break;case"cr":o.act="cr";break;case"cd":o.act="cd",o.path=t[1];break;case"ls":o.act="ls",o.path=t[1];break;case"fr":o.act="fr",o.path=t[1];break;case"fw":const v=atob(t[2]),h=new Uint8Array(v.length);for(let w=0;w<v.length;w++)h[w]=v.charCodeAt(w);o.act="fw",o.path=t[1],o.data=h;break;case"sh":o.act="sh",o.name=btoa(t.slice(1).join(" "));break;case"pl":o.act="pl",o.name=t[1],o.args=t.slice(2).join(" ");break;default:(n.cmd=="?"||n.cmd=="help")&&(u.writeln(""),u.writeln("help/cls  \u5E2E\u52A9/\u6E05\u5C4F ctrl+s \u4FDD\u5B58\u4F1A\u8BDD\u8BB0\u5F55"),u.writeln("sh        \u6267\u884C\u547D\u4EE4 sh cmd"),u.writeln("ls        \u679A\u4E3E\u6587\u4EF6 ls path"),u.writeln("cd        \u5207\u6362\u76EE\u5F55 cd path"),u.writeln("ps        \u67E5\u770B\u8FDB\u7A0B ps"),u.writeln("ss        \u67E5\u770B\u7F51\u7EDC ss"),u.writeln("cr        \u6267\u884C\u622A\u5C4F cr"),u.writeln("fr        \u8BFB\u53D6\u6587\u4EF6 fr path"),u.writeln("fw        \u5199\u5165\u6587\u4EF6 fw path base64"),u.writeln("pl        \u6267\u884C\u63D2\u4EF6 pl name <args>"),u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`)),n.cmd=="cls"&&(u.reset(),u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`)),n.cmd="";return}let C=F.AgentEvent.create();C.action=o,a("onsend",C),u.writeln(n.cmd),s.success(`\u547D\u4EE4:${n.cmd} \u5DF2\u53D1\u9001\uFF01 \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002`),n.history.push(n.cmd),n.cmd=""}return J(()=>{u.open(f.value),u.loadAddon(g),g.fit(),new ResizeObserver(()=>{g.fit()}).observe(f.value),u.reset()}),fe(()=>{u.dispose()}),X(()=>{if(e.agent&&n.agent.id!=e.agent.id){n.agent=e.agent;let t=e.agent.process.replaceAll("\\","/").split("/");t.pop(),n.pwd=t.join("/"),u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`)}if(e.event&&(e.event.plugin&&(e.event.plugin.act==="ss"&&e.event.plugin.name==="npc2"&&setTimeout(()=>{n.agent.npc2=!0},5e3),e.event.plugin.act==="dd"&&(u.writeln(e.event.plugin.name,e.event.plugin.args),u.writeln(e.event.plugin.data),u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`))),e.event.action)){switch(u.writeln(""),e.event.action.act){case"cd":n.pwd=e.event.reqcd.path.replaceAll("\\","/"),u.writeln(e.event.action.path);break;case"ls":e.event.action.entrys.map(t=>{var C;const o=t.isfile?"\u{1F4C4}":"\u{1F4C1}";u.writeln(`${o}   ${t.path.padEnd(88)}  ${((C=j(t.modified*1e3))==null?void 0:C.padEnd(20))||"".padEnd(20)} ${A(t.size)}`)});break;case"fw":u.writeln(`\u6587\u4EF6\u5199\u5165\u6210\u529F\uFF01 \u6587\u4EF6\u540D:${e.event.action.path} `);break;case"fr":e.event.action.data.length<=4096?u.writeln(c(e.event.action.data)):u.writeln(`\u6587\u4EF6\u8BFB\u53D6\u6210\u529F\uFF01 \u8BF7\u524D\u5F80\u654F\u611F\u6587\u4EF6\u9879\u4E0B\u8F7D\u6587\u4EF6, \u6587\u4EF6\u5927\u5C0F ${A(e.event.action.data.length)} `);break;case"sh":u.writeln(c(e.event.action.data));break;case"ss":u.writeln(c(e.event.action.data));break;case"ps":u.writeln(c(e.event.action.data));break;case"pl":u.writeln(c(e.event.action.data));break;case"cr":u.writeln(`\u5C4F\u5E55\u622A\u56FE\u6210\u529F\uFF01 \u8BF7\u524D\u5F80\u654F\u611F\u6587\u4EF6\u9879\u67E5\u770B\u622A\u56FE, \u6587\u4EF6\u5927\u5C0F ${A(e.event.action.data.length)} \u3002`);break;case"err":u.writeln(`\u51FA\u9519\u4E86\uFF01 \u9519\u8BEF ${c(e.event.action.data)}`);break}u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`)}}),{state:n,agentinfo:m,terminalRef:f,CmdSend:se,Screen:y,beforeUpload:oe,NpcExit:D,Npc2Load:te,registerModal:b,CreateProxy:ne,RunPlugin:ae,PlugSend:ue,OpenCmd:$,OpenFile:P,OpenVnc:x,OpenRdp:ee}}}),Ie={class:"flex flex-col h-full"},Ue={key:0,class:"mt-2 flex flex-grow-0"},We={class:"terminal-body flex-1 min-h-0"},ze={ref:"terminalRef",class:"terminal"};function Ve(e,a,f,n,r,b){const d=E("PopConfirmButton"),l=E("a-button"),s=E("Upload"),m=E("Description"),g=E("CollapseContainer"),u=E("a-input"),A=E("PageWrapper"),c=E("ProxyModal"),y=E("PlugModal");return k(),S(H,null,[i(A,{dense:"",contentFullHeight:"",contentBackground:"",fixedHeight:""},{default:p(()=>[R("div",Ie,[i(g,{class:"flex-shrink-0"},{default:p(()=>[e.state.agent.ntype==="npc1"?(k(),S(H,{key:0},[i(d,{disabled:e.state.agent.ntype!=="npc1",title:"\u786E\u5B9A\u9500\u6BC1\u8BE5NPC\u5417?",type:"danger",onConfirm:e.NpcExit},{default:p(()=>[...a[4]||(a[4]=[B("\u9500\u6BC1NPC",-1)])]),_:1},8,["disabled","onConfirm"]),i(s,{"show-upload-list":!1,"before-upload":e.beforeUpload,multiple:!0,disabled:e.state.agent.ntype!=="npc1"},{default:p(()=>[i(l,{type:"primary",disabled:e.state.agent.ntype!=="npc1"},{default:p(()=>[...a[5]||(a[5]=[B("\u4E0A\u4F20\u6587\u4EF6",-1)])]),_:1},8,["disabled"])]),_:1},8,["before-upload","disabled"]),i(l,{onClick:e.Screen,type:"primary",disabled:e.state.agent.ntype!=="npc1"},{default:p(()=>[...a[6]||(a[6]=[B(" \u4E00\u952E\u622A\u5C4F ",-1)])]),_:1},8,["onClick","disabled"]),i(l,{type:"ghost"})],64)):_("",!0),i(d,{type:"danger",title:"\u786E\u5B9A"+(e.state.agent.npc2?"\u5378\u8F7D":"\u52A0\u8F7D")+"NPC2\u5417?",onConfirm:e.Npc2Load},{default:p(()=>[B(me(e.state.agent.npc2?"\u5378\u8F7D":"\u52A0\u8F7D")+"NPC2",1)]),_:1},8,["title","onConfirm"]),i(d,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u6587\u4EF6\u7BA1\u7406\u5417?",type:"primary",onConfirm:a[0]||(a[0]=D=>e.OpenFile(e.state.agent.id))},{default:p(()=>[...a[7]||(a[7]=[B("\u6587\u4EF6\u7BA1\u7406",-1)])]),_:1},8,["disabled"]),i(d,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u865A\u62DF\u7EC8\u7AEF\u5417?",type:"primary",onConfirm:a[1]||(a[1]=D=>e.OpenCmd(e.state.agent.id))},{default:p(()=>[...a[8]||(a[8]=[B("\u865A\u62DF\u7EC8\u7AEF",-1)])]),_:1},8,["disabled"]),i(d,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u865A\u62DF\u684C\u9762\u5417?",type:"primary",onConfirm:a[2]||(a[2]=D=>e.OpenVnc(e.state.agent.id))},{default:p(()=>[...a[9]||(a[9]=[B("\u865A\u62DF\u684C\u9762",-1)])]),_:1},8,["disabled"]),i(l,{onClick:e.CreateProxy,type:"primary",disabled:!e.state.agent.npc2},{default:p(()=>[...a[10]||(a[10]=[B("\u65B0\u5EFA\u96A7\u9053",-1)])]),_:1},8,["onClick","disabled"]),i(l,{type:"ghost"}),e.state.agent.ntype==="npc1"?(k(),U(l,{key:1,onClick:e.RunPlugin,type:"primary"},{default:p(()=>[...a[11]||(a[11]=[B(" \u8FD0\u884C\u63D2\u4EF6 ",-1)])]),_:1},8,["onClick"])):_("",!0),i(m,{onRegister:e.agentinfo,data:e.state.agent},null,8,["onRegister","data"])]),_:1}),e.state.agent.ntype==="npc1"?(k(),S("div",Ue,[i(u,{disabled:e.state.agent.ntype!=="npc1",value:e.state.cmd,"onUpdate:value":a[3]||(a[3]=D=>e.state.cmd=D),onPressEnter:e.CmdSend,placeholder:"\u8F93\u5165help\u67E5\u770B\u5E2E\u52A9",autocomplete:"on"},{addonBefore:p(()=>[...a[12]||(a[12]=[B("\u8F93\u5165\u547D\u4EE4\uFF1A ",-1)])]),_:1},8,["disabled","value","onPressEnter"]),i(l,{type:"danger",onClick:e.CmdSend,disabled:e.state.agent.ntype!=="npc1"},{default:p(()=>[...a[13]||(a[13]=[B("\u53D1\u9001",-1)])]),_:1},8,["onClick","disabled"])])):_("",!0),R("div",We,[R("div",ze,null,512)])])]),_:1}),i(c,{onRegister:e.registerModal},null,8,["onRegister"]),i(y,{onRegister:e.registerModal,onSuccess:e.PlugSend},null,8,["onRegister","onSuccess"])],64)}var je=I(Oe,[["render",Ve],["__scopeId","data-v-17e46379"]]);const He=O({name:"AgentWork",components:{PageWrapper:G,PopConfirmButton:Q,Tabs:K,TabPane:K.TabPane,AgentInfo:je},setup(){const{currentRoute:e}=Fe(),a=Ee(()=>M(e).params),{closeCurrent:f,setTitle:n}=be(),r=Y({uid:we(),agent:{},event:{}}),{apiUrl:b="/manjusaka"}=Ce(),d=(window.location.protocol==="https:"?"wss:":"ws:")+"//"+window.location.host+b+"/webproxy/log/"+r.uid,{data:l,send:s,close:m}=ve(d,{autoReconnect:!1,heartbeat:!1});function g(){m(),f()}function u(c){if(c&&r.agent.id){c.id=r.uid,c.sendto=r.agent.id;let D=F.AgentEvent.verify(c);if(D)throw Error(D);var y=F.AgentEvent.encode(c).finish();let $="";for(let P=0;P<y.length;P++)$+=String.fromCharCode(y[P]);T({action:"addevent",data:{id:r.agent.id,data:btoa($)}})}}function A(){T({action:"agentinfo",data:{id:M(a).id}}).then(c=>{r.agent=c,n("\u5DE5\u4F5C\u53F0 - "+r.agent.username+"@"+r.agent.intranet)}).catch(()=>{})}return X(()=>{if(l.value)try{l.value.arrayBuffer().then(c=>new Uint8Array(c)).then(c=>{let y=F.AgentEvent.decode(c);r.event=y})}catch(c){}}),J(()=>{A()}),{state:r,CloseWork:g,OnHttpSend:u}}});function Ke(e,a,f,n,r,b){const d=E("AgentInfo"),l=E("TabPane"),s=E("PopConfirmButton"),m=E("Tabs"),g=E("PageWrapper");return k(),U(g,{dense:"",contentFullHeight:"",contentBackground:"",fixedHeight:""},{default:p(()=>[i(m,{size:"small"},{tabBarExtraContent:p(()=>[i(s,{title:"\u786E\u5B9A\u65AD\u5F00\u8FDE\u63A5?",type:"danger",onConfirm:e.CloseWork},{default:p(()=>[...a[0]||(a[0]=[B("\u65AD\u5F00\u8FDE\u63A5",-1)])]),_:1},8,["onConfirm"])]),default:p(()=>[i(l,{tab:"NPC\u8BE6\u60C5",key:"1",closable:!0},{default:p(()=>[i(d,{agent:e.state.agent,event:e.state.event,onOnsend:e.OnHttpSend},null,8,["agent","event","onOnsend"])]),_:1})]),_:1})]),_:1})}var Et=I(He,[["render",Ke]]);export{Et as default};
