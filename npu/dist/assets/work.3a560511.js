var I=Math.pow;import{a as V}from"./index.7d1af758.js";import{b8 as ne,r as R,a as T,dc as ae,b as K,dY as ue,dM as G,f as q,bu as oe,e6 as re,am as L,a2 as se,aa as Q,e7 as _,aQ as Y,cj as O,aR as m,o as k,z as S,k as r,j as i,l as M,W,m as F,C as N,t as ie,i as J,q as le,b0 as de,c as ce,bR as pe,s as fe,e8 as me}from"./index.59109d81.js";import{T as z}from"./index.bea4f14b.js";import{B as ge,U as Fe,j as Ee}from"./useForm.a5b01752.js";import{n as f}from"./nps.a5baa383.js";import{x as j,a as H}from"./addon-fit.5989f935.js";import{I as be}from"./index.5d8d8edd.js";import{T as Ce}from"./index.72ea0479.js";import{D as ve}from"./index.0f786aec.js";import{a as Be}from"./index.abeaa45a.js";import{a as De}from"./download.60714c4e.js";import{R as Ae}from"./RoleModal.6d237f64.js";import"./index.169a2f8c.js";import"./index.6af6e8ee.js";import"./useSize.f495344d.js";import"./useContentViewHeight.b742a811.js";import"./ArrowLeftOutlined.76351c5d.js";import"./FullscreenOutlined.e9ba2b3a.js";import"./_baseIteratee.2ac5361a.js";import"./index.24c08581.js";import"./index.9a88e72b.js";import"./isEqual.442fc559.js";import"./index.ef80d76f.js";import"./index.3b17542c.js";import"./index.b51e258d.js";function we(e){if(!ne())throw new Error("useDescription() can only be used inside setup() or functional components!");const a=R(null),b=R(!1);function o(C){T(b)&&ae()||(a.value=C,e&&C.setDescProps(e),b.value=!0)}return[o,{setDescProps:C=>{var p;(p=T(a))==null||p.setDescProps(C)}}]}const ye=K({name:"AgentInfo",components:{PageWrapper:V,CollapseContainer:ue,BasicForm:ge,Description:ve,InputNumber:be,Upload:Fe,PopConfirmButton:G,Time:Ce,Terminal:j.exports.Terminal,FitAddon:H.exports.FitAddon,ProxyModal:Ae},props:["agent","event"],emits:["onsend"],setup(e,{emit:a}){const b=R(null),o=q({agent:{},cmd:"",pwd:"",history:[],crtlist:[]}),l=oe(),[C,{openModal:p}]=Be(),{createMessage:s}=le(),[y]=we({column:2,schema:[{field:"id",label:"NPCID"},{field:"pid",label:"PID"},{field:"platform",label:"\u7CFB\u7EDF"},{field:"arch",label:"\u6784\u67B6"},{field:"hostname",label:"\u4E3B\u673A\u540D"},{field:"intranet",label:"\u5185\u7F51\u5730\u5740"},{field:"username",label:"\u7528\u6237\u540D"},{field:"internet",label:"\u516C\u7F51\u5730\u5740"},{field:"target",label:"\u8DEF\u7531"},{field:"note",label:"\u5907\u6CE8"},{field:"ntype",label:"NPC\u7C7B\u578B"},{field:"updateat",label:"\u6700\u540E\u56DE\u8FDE",render:(t,u)=>_(u.updateat*1e3)},{field:"process",label:"\u8FDB\u7A0B\u8DEF\u5F84"}]}),B=new H.exports.FitAddon,n=new j.exports.Terminal({fontSize:15,fontWeight:"normal",fontFamily:"Consolas",rendererType:"canvas",cursorBlink:!1,disableStdin:!1,allowProposedApi:!0,fastScrollModifier:"ctrl",scrollback:1e6,theme:{background:"#002833",cursor:"#268F81"}});n.onKey(t=>{if((t.domEvent.ctrlKey||t.domEvent.metaKey)&&(t.domEvent.preventDefault(),t.domEvent.key==="c"&&re(n.getSelection()),t.domEvent.key==="s")){const u=n.buffer.active;let c="";for(let g=0;g<u.length;g++){const w=u.getLine(g);w&&(c+=w.translateToString(!0)+`
`)}De(c,o.agent.intranet+".log")}});const A=t=>{const u=["Bytes","KB","MB","GB","TB"];if(t==0)return"-";const c=Math.floor(Math.log(t)/Math.log(1024)),g=(t/I(1024,c)).toFixed(0);return c===0?"1 KB":`${g} ${u[c]}`},v=t=>new TextDecoder().decode(t).replace(/\r\n|\r|\n/g,`\r
`);function d(){let t=f.Action.create();t.act="cr";let u=f.AgentEvent.create();u.action=t,a("onsend",u),s.success("\u622A\u5C4F\u547D\u4EE4\u5DF2\u53D1\u9001\uFF01 \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002")}function E(){let t=f.Config.create();t.action=2;let u=f.AgentEvent.create();u.conf=t,a("onsend",u),s.success("NPC\u9500\u6BC1\u547D\u4EE4\u53D1\u9001")}function P(t){l("/agentcmd/"+t)}function $(t){l("/agentfile/"+t)}function h(t){l("/agentvnc/"+t)}function X(t){l("/agentrdp/"+t)}function Z(){if(o.agent.npc2)O({action:"npc2stop",data:{id:o.agent.id}}).then(t=>{o.agent.npc2=!1}).catch(t=>{});else{let t=f.Plugin.create();t.act="ex",t.name="npc2";let u=f.AgentEvent.create();u.plugin=t,a("onsend",u),s.success("NPC2\u52A0\u8F7D\u4E2D\u3002\u3002\u3002 \u8BF7\u7B49\u5F85\u8FD4\u56DE\uFF01")}}function x(){p(!0,{record:{id:o.agent.id}})}const ee=t=>{const u=new FileReader;return u.readAsArrayBuffer(t),u.onload=c=>{var g;if(((g=c.target)==null?void 0:g.result)instanceof ArrayBuffer){const w=new Uint8Array(c.target.result);let D=f.Action.create();D.act="fw",D.path=t.name,D.data=w;let U=f.AgentEvent.create();U.action=D,a("onsend",U),s.success(`\u6587\u4EF6:${t.name} \u5927\u5C0F:${A(t.size)} \u4E0A\u4F20\u4E2D... \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002`)}},u.onerror=()=>{s.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},!1};function te(){let t=o.cmd.split(" "),u=f.Action.create();switch(f.Entry.create(),t[0]){case"ss":u.act="ss";break;case"ps":u.act="ps";break;case"cr":u.act="cr";break;case"cd":u.act="cd",u.path=t[1];break;case"ls":u.act="ls",u.path=t[1];break;case"fr":u.act="fr",u.path=t[1];break;case"fw":const g=atob(t[2]),w=new Uint8Array(g.length);for(let D=0;D<g.length;D++)w[D]=g.charCodeAt(D);u.act="fw",u.path=t[1],u.data=w;break;case"sh":u.act="sh",u.name=btoa(t.slice(1).join(" "));break;case"pl":u.act="pl",u.name=t[1],u.args=t.slice(2).join(" ");break;default:(o.cmd=="?"||o.cmd=="help")&&(n.writeln(""),n.writeln("help/cls  \u5E2E\u52A9/\u6E05\u5C4F ctrl+s \u4FDD\u5B58\u4F1A\u8BDD\u8BB0\u5F55"),n.writeln("sh        \u6267\u884C\u547D\u4EE4 sh cmd"),n.writeln("ls        \u679A\u4E3E\u6587\u4EF6 ls path"),n.writeln("cd        \u5207\u6362\u76EE\u5F55 cd path"),n.writeln("ps        \u67E5\u770B\u8FDB\u7A0B ps"),n.writeln("ss        \u67E5\u770B\u7F51\u7EDC ss"),n.writeln("cr        \u6267\u884C\u622A\u5C4F cr"),n.writeln("fr        \u8BFB\u53D6\u6587\u4EF6 fr path"),n.writeln("fw        \u5199\u5165\u6587\u4EF6 fw path base64"),n.writeln("pl        \u6267\u884C\u63D2\u4EF6 pl name <args>"),n.write(`[${o.agent.username}@${o.agent.hostname} ${o.pwd}]#`)),o.cmd=="cls"&&(n.reset(),n.write(`[${o.agent.username}@${o.agent.hostname} ${o.pwd}]#`)),o.cmd="";return}let c=f.AgentEvent.create();c.action=u,a("onsend",c),n.writeln(o.cmd),s.success(`\u547D\u4EE4:${o.cmd} \u5DF2\u53D1\u9001\uFF01 \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002`),o.history.push(o.cmd),o.cmd=""}return L(()=>{n.open(b.value),n.loadAddon(B),B.fit(),new ResizeObserver(()=>{B.fit()}).observe(b.value),n.reset()}),se(()=>{n.dispose()}),Q(()=>{if(e.agent&&o.agent.id!=e.agent.id){o.agent=e.agent;let t=e.agent.process.replaceAll("\\","/").split("/");t.pop(),o.pwd=t.join("/"),n.write(`[${o.agent.username}@${o.agent.hostname} ${o.pwd}]#`)}if(e.event&&(e.event.plugin&&(e.event.plugin.act==="ss"&&e.event.plugin.name==="npc2"&&setTimeout(()=>{o.agent.npc2=!0},5e3),e.event.plugin.act==="dd"&&n.write(e.event.plugin.data)),e.event.action)){switch(n.writeln(""),e.event.action.act){case"cd":o.pwd=e.event.reqcd.path.replaceAll("\\","/"),n.writeln(e.event.action.path);break;case"ls":e.event.action.entrys.map(t=>{var c;const u=t.isfile?"\u{1F4C4}":"\u{1F4C1}";n.writeln(`${u}   ${t.path.padEnd(88)}  ${((c=_(t.modified*1e3))==null?void 0:c.padEnd(20))||"".padEnd(20)} ${A(t.size)}`)});break;case"fw":n.writeln(`\u6587\u4EF6\u5199\u5165\u6210\u529F\uFF01 \u6587\u4EF6\u540D:${e.event.action.path} `);break;case"fr":e.event.action.data.length<=4096?n.writeln(v(e.event.action.data)):n.writeln(`\u6587\u4EF6\u8BFB\u53D6\u6210\u529F\uFF01 \u8BF7\u524D\u5F80\u654F\u611F\u6587\u4EF6\u9879\u4E0B\u8F7D\u6587\u4EF6, \u6587\u4EF6\u5927\u5C0F ${A(e.event.action.data.length)} `);break;case"sh":n.writeln(v(e.event.action.data));break;case"ss":n.writeln(v(e.event.action.data));break;case"ps":n.writeln(v(e.event.action.data));break;case"pl":n.writeln(v(e.event.action.data));break;case"cr":n.writeln(`\u5C4F\u5E55\u622A\u56FE\u6210\u529F\uFF01 \u8BF7\u524D\u5F80\u654F\u611F\u6587\u4EF6\u9879\u67E5\u770B\u622A\u56FE, \u6587\u4EF6\u5927\u5C0F ${A(e.event.action.data.length)} \u3002`);break;case"err":n.writeln(`\u51FA\u9519\u4E86\uFF01 \u9519\u8BEF ${v(e.event.action.data)}`);break}n.write(`[${o.agent.username}@${o.agent.hostname} ${o.pwd}]#`)}}),{state:o,agentinfo:y,terminalRef:b,CmdSend:te,Screen:d,beforeUpload:ee,NpcExit:E,Npc2Load:Z,registerModal:C,CreateProxy:x,OpenCmd:P,OpenFile:$,OpenVnc:h,OpenRdp:X}}}),he={class:"flex flex-col h-full"},ke={key:0,class:"mt-2 flex flex-grow-0"},Pe={class:"terminal-body flex-1 min-h-0"},$e={ref:"terminalRef",class:"terminal"};function Te(e,a,b,o,l,C){const p=m("PopConfirmButton"),s=m("a-button"),y=m("Upload"),B=m("Description"),n=m("CollapseContainer"),A=m("a-input"),v=m("PageWrapper"),d=m("ProxyModal");return k(),S(W,null,[r(v,{dense:"",contentFullHeight:"",contentBackground:"",fixedHeight:""},{default:i(()=>[M("div",he,[r(n,{class:"flex-shrink-0"},{default:i(()=>[e.state.agent.ntype==="npc1"?(k(),S(W,{key:0},[r(p,{disabled:e.state.agent.ntype!=="npc1",title:"\u786E\u5B9A\u9500\u6BC1\u8BE5NPC\u5417?",type:"danger",onConfirm:e.NpcExit},{default:i(()=>[...a[4]||(a[4]=[F("\u9500\u6BC1NPC",-1)])]),_:1},8,["disabled","onConfirm"]),r(y,{"show-upload-list":!1,"before-upload":e.beforeUpload,multiple:!0,disabled:e.state.agent.ntype!=="npc1"},{default:i(()=>[r(s,{type:"primary",disabled:e.state.agent.ntype!=="npc1"},{default:i(()=>[...a[5]||(a[5]=[F("\u4E0A\u4F20\u6587\u4EF6",-1)])]),_:1},8,["disabled"])]),_:1},8,["before-upload","disabled"]),r(s,{onClick:e.Screen,type:"primary",disabled:e.state.agent.ntype!=="npc1"},{default:i(()=>[...a[6]||(a[6]=[F(" \u4E00\u952E\u622A\u5C4F ",-1)])]),_:1},8,["onClick","disabled"]),r(s,{type:"ghost"})],64)):N("",!0),r(p,{type:"danger",title:"\u786E\u5B9A"+(e.state.agent.npc2?"\u5378\u8F7D":"\u52A0\u8F7D")+"NPC2\u5417?",onConfirm:e.Npc2Load},{default:i(()=>[F(ie(e.state.agent.npc2?"\u5378\u8F7D":"\u52A0\u8F7D")+"NPC2",1)]),_:1},8,["title","onConfirm"]),r(p,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u6587\u4EF6\u7BA1\u7406\u5417?",type:"primary",onConfirm:a[0]||(a[0]=E=>e.OpenFile(e.state.agent.id))},{default:i(()=>[...a[7]||(a[7]=[F("\u6587\u4EF6\u7BA1\u7406",-1)])]),_:1},8,["disabled"]),r(p,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u865A\u62DF\u7EC8\u7AEF\u5417?",type:"primary",onConfirm:a[1]||(a[1]=E=>e.OpenCmd(e.state.agent.id))},{default:i(()=>[...a[8]||(a[8]=[F("\u865A\u62DF\u7EC8\u7AEF",-1)])]),_:1},8,["disabled"]),r(p,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u865A\u62DF\u684C\u9762\u5417?",type:"primary",onConfirm:a[2]||(a[2]=E=>e.OpenVnc(e.state.agent.id))},{default:i(()=>[...a[9]||(a[9]=[F("\u865A\u62DF\u684C\u9762",-1)])]),_:1},8,["disabled"]),r(s,{onClick:e.CreateProxy,type:"primary",disabled:!e.state.agent.npc2},{default:i(()=>[...a[10]||(a[10]=[F("\u65B0\u5EFA\u96A7\u9053",-1)])]),_:1},8,["onClick","disabled"]),r(s,{type:"ghost"}),e.state.agent.ntype==="npc1"?(k(),J(s,{key:1,click:"GetPass",type:"primary",disabled:""},{default:i(()=>[...a[11]||(a[11]=[F(" \u83B7\u53D6\u5BC6\u7801 ",-1)])]),_:1})):N("",!0),r(B,{onRegister:e.agentinfo,data:e.state.agent},null,8,["onRegister","data"])]),_:1}),e.state.agent.ntype==="npc1"?(k(),S("div",ke,[r(A,{disabled:e.state.agent.ntype!=="npc1",value:e.state.cmd,"onUpdate:value":a[3]||(a[3]=E=>e.state.cmd=E),onPressEnter:e.CmdSend,placeholder:"\u8F93\u5165help\u67E5\u770B\u5E2E\u52A9",autocomplete:"on"},{addonBefore:i(()=>[...a[12]||(a[12]=[F("\u8F93\u5165\u547D\u4EE4\uFF1A ",-1)])]),_:1},8,["disabled","value","onPressEnter"]),r(s,{type:"danger",onClick:e.CmdSend,disabled:e.state.agent.ntype!=="npc1"},{default:i(()=>[...a[13]||(a[13]=[F("\u53D1\u9001",-1)])]),_:1},8,["onClick","disabled"])])):N("",!0),M("div",Pe,[M("div",$e,null,512)])])]),_:1}),r(d,{onRegister:e.registerModal},null,8,["onRegister"])],64)}var Se=Y(ye,[["render",Te],["__scopeId","data-v-9cbaba40"]]);const Me=K({name:"AgentWork",components:{PageWrapper:V,PopConfirmButton:G,Tabs:z,TabPane:z.TabPane,AgentInfo:Se},setup(){const{currentRoute:e}=de(),a=ce(()=>T(e).params),{closeCurrent:b,setTitle:o}=pe(),l=q({uid:Ee(),agent:{},event:{}}),{apiUrl:C="/manjusaka"}=fe(),p=(window.location.protocol==="https:"?"wss:":"ws:")+"//"+window.location.host+C+"/webproxy/log/"+l.uid,{data:s,send:y,close:B}=me(p,{autoReconnect:!1,heartbeat:!1});function n(){B(),b()}function A(d){if(d&&l.agent.id){d.id=l.uid,d.sendto=l.agent.id;let P=f.AgentEvent.verify(d);if(P)throw Error(P);var E=f.AgentEvent.encode(d).finish();let $="";for(let h=0;h<E.length;h++)$+=String.fromCharCode(E[h]);O({action:"addevent",data:{id:l.agent.id,data:btoa($)}})}}function v(){O({action:"agentinfo",data:{id:T(a).id}}).then(d=>{l.agent=d,o("\u5DE5\u4F5C\u53F0 - "+l.agent.username+"@"+l.agent.intranet)}).catch(()=>{})}return Q(()=>{if(s.value)try{s.value.arrayBuffer().then(d=>new Uint8Array(d)).then(d=>{let E=f.AgentEvent.decode(d);l.event=E})}catch(d){}}),L(()=>{v()}),{state:l,CloseWork:n,OnHttpSend:A}}});function Ne(e,a,b,o,l,C){const p=m("AgentInfo"),s=m("TabPane"),y=m("PopConfirmButton"),B=m("Tabs"),n=m("PageWrapper");return k(),J(n,{dense:"",contentFullHeight:"",contentBackground:"",fixedHeight:""},{default:i(()=>[r(B,{size:"small"},{tabBarExtraContent:i(()=>[r(y,{title:"\u786E\u5B9A\u65AD\u5F00\u8FDE\u63A5?",type:"danger",onConfirm:e.CloseWork},{default:i(()=>[...a[0]||(a[0]=[F("\u65AD\u5F00\u8FDE\u63A5",-1)])]),_:1},8,["onConfirm"])]),default:i(()=>[r(s,{tab:"NPC\u8BE6\u60C5",key:"1",closable:!0},{default:i(()=>[r(p,{agent:e.state.agent,event:e.state.event,onOnsend:e.OnHttpSend},null,8,["agent","event","onOnsend"])]),_:1})]),_:1})]),_:1})}var rt=Y(Me,[["render",Ne]]);export{rt as default};
