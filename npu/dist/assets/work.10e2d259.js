var z=Math.pow;var V=(e,a,p)=>new Promise((n,r)=>{var E=s=>{try{l(p.next(s))}catch(m){r(m)}},d=s=>{try{l(p.throw(s))}catch(m){r(m)}},l=s=>s.done?n(s.value):Promise.resolve(s.value).then(E,d);l((p=p.apply(e,a)).next())});import{a as Q}from"./index.242d16c8.js";import{b8 as ce,r as N,a as M,dc as pe,b as O,aQ as I,aR as F,o as k,i as U,j as c,k as i,aT as fe,cj as T,dY as me,dM as Y,f as x,bu as ge,e6 as Fe,am as J,a2 as Ee,aa as X,e7 as j,z as S,l as R,W as H,m as D,C as _,t as be,q as Ce,b0 as ve,c as Be,bR as De,s as we,e8 as ye}from"./index.0bfc751b.js";import{T as K}from"./index.ef5e56b1.js";import{B as Z,u as Ae,U as he,j as ke}from"./useForm.3c23bbf7.js";import{n as g}from"./nps.08e8601b.js";import{x as q,a as L}from"./addon-fit.5989f935.js";import{I as Pe}from"./index.314c218e.js";import{T as $e}from"./index.16e9a5d4.js";import{D as Me}from"./index.f24fabcf.js";import{B as Te,u as Se,a as G}from"./index.7dacf1f4.js";import{a as Re}from"./download.ab84bb41.js";import{R as _e}from"./RoleModal.668a187c.js";import"./index.701d5ab5.js";import"./index.71b679cd.js";import"./useSize.df470e37.js";import"./useContentViewHeight.cc5ed19b.js";import"./ArrowLeftOutlined.b5c738ec.js";import"./FullscreenOutlined.44ecaf61.js";import"./_baseIteratee.ae4a1dda.js";import"./index.88ce77f7.js";import"./index.fac76bbd.js";import"./isEqual.6389973c.js";import"./index.2d06da9e.js";import"./index.c66248c6.js";import"./index.6b2df8cb.js";function Ne(e){if(!ce())throw new Error("useDescription() can only be used inside setup() or functional components!");const a=N(null),p=N(!1);function n(E){M(p)&&pe()||(a.value=E,e&&E.setDescProps(e),p.value=!0)}return[n,{setDescProps:E=>{var d;(d=M(a))==null||d.setDescProps(E)}}]}const Oe=O({name:"PlugModal",components:{BasicModal:Te,BasicForm:Z},emits:["success"],setup(e,a){const[p,{setFieldsValue:n,getFieldsValue:r}]=Ae({labelWidth:100,schemas:[{required:!0,field:"name",component:"ApiSelect",label:"\u63D2\u4EF6\u540D\u79F0",componentProps:{api:T,params:{action:"pluglist"},labelField:"name",valueField:"name",resultField:"items",onChange:(s,m)=>{n(m)}}},{field:"entry",component:"Input",label:"\u5165\u53E3\u70B9"},{field:"args",component:"InputTextArea",label:"\u8FD0\u884C\u53C2\u6570",componentProps:{autoSize:!0}}],showResetButton:!1,showSubmitButton:!1}),E=Se(s=>V(this,null,function*(){n(s)}));function d(s){return s.includes(".")?s.split(".").pop().toLowerCase():""}function l(){let s=r(),m=g.AgentEvent.create(),C=g.Plugin.create();C.act="ex",C.name=s.name.split(".")[0],C.entry=s.entry,C.args=s.args,C.arch=d(s.name),m.plugin=C,a.emit("success",m)}return{registerModal:E,registerForm:p,handleSubmit:l}}});function Ie(e,a,p,n,r,E){const d=F("BasicForm"),l=F("BasicModal");return k(),U(l,fe(e.$attrs,{width:600,onRegister:e.registerModal,title:"\u8FD0\u884C\u63D2\u4EF6",okText:"\u4E0B\u53D1\u6307\u4EE4",onOk:e.handleSubmit}),{default:c(()=>[i(d,{onRegister:e.registerForm},null,8,["onRegister"])]),_:1},16,["onRegister","onOk"])}var Ue=I(Oe,[["render",Ie]]);const We=O({name:"AgentInfo",components:{PageWrapper:Q,CollapseContainer:me,BasicForm:Z,Description:Me,InputNumber:Pe,Upload:he,PopConfirmButton:Y,Time:$e,Terminal:q.exports.Terminal,FitAddon:L.exports.FitAddon,ProxyModal:_e,PlugModal:Ue},props:["agent","event"],emits:["onsend"],setup(e,{emit:a}){const p=N(null),n=x({agent:{},cmd:"",pwd:"",history:[],crtlist:[]}),r=ge(),[E,{openModal:d,closeModal:l}]=G(),[s,{openModal:m,closeModal:C}]=G(),{createMessage:w}=Ce(),[P]=Ne({column:2,schema:[{field:"id",label:"NPCID"},{field:"pid",label:"PID"},{field:"platform",label:"\u7CFB\u7EDF"},{field:"arch",label:"\u6784\u67B6"},{field:"hostname",label:"\u4E3B\u673A\u540D"},{field:"intranet",label:"\u5185\u7F51\u5730\u5740"},{field:"username",label:"\u7528\u6237\u540D"},{field:"internet",label:"\u516C\u7F51\u5730\u5740"},{field:"target",label:"\u8DEF\u7531"},{field:"note",label:"\u5907\u6CE8"},{field:"ntype",label:"NPC\u7C7B\u578B"},{field:"updateat",label:"\u6700\u540E\u56DE\u8FDE",render:(t,o)=>j(o.updateat*1e3)},{field:"process",label:"\u8FDB\u7A0B\u8DEF\u5F84"}]}),f=new L.exports.FitAddon,u=new q.exports.Terminal({fontSize:15,fontWeight:"normal",fontFamily:"Consolas",rendererType:"canvas",cursorBlink:!1,disableStdin:!1,allowProposedApi:!0,fastScrollModifier:"ctrl",scrollback:1e6,theme:{background:"#002833",cursor:"#268F81"}});u.onKey(t=>{if((t.domEvent.ctrlKey||t.domEvent.metaKey)&&(t.domEvent.preventDefault(),t.domEvent.key==="c"&&Fe(u.getSelection()),t.domEvent.key==="s")){const o=u.buffer.active;let b="";for(let B=0;B<o.length;B++){const h=o.getLine(B);h&&(b+=h.translateToString(!0)+`
`)}Re(b,n.agent.intranet+".log")}});const v=t=>{const o=["Bytes","KB","MB","GB","TB"];if(t==0)return"-";const b=Math.floor(Math.log(t)/Math.log(1024)),B=(t/z(1024,b)).toFixed(0);return b===0?"1 KB":`${B} ${o[b]}`},y=t=>new TextDecoder().decode(t).replace(/\r\n|\r|\n/g,`\r
`);function $(){let t=g.Action.create();t.act="cr";let o=g.AgentEvent.create();o.action=t,a("onsend",o),w.success("\u622A\u5C4F\u547D\u4EE4\u5DF2\u53D1\u9001\uFF01 \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002")}function ee(){let t=g.Config.create();t.action=2;let o=g.AgentEvent.create();o.conf=t,a("onsend",o),w.success("NPC\u9500\u6BC1\u547D\u4EE4\u53D1\u9001")}function te(t){r("/agentcmd/"+t)}function ne(t){r("/agentfile/"+t)}function ae(t){r("/agentvnc/"+t)}function ue(t){r("/agentrdp/"+t)}function oe(){if(n.agent.npc2)T({action:"npc2stop",data:{id:n.agent.id}}).then(t=>{n.agent.npc2=!1}).catch(t=>{});else{let t=g.Plugin.create();t.act="ex",t.name="npc2";let o=g.AgentEvent.create();o.plugin=t,a("onsend",o),w.success("NPC2\u52A0\u8F7D\u4E2D\u3002\u3002\u3002 \u8BF7\u7B49\u5F85\u8FD4\u56DE\uFF01")}}function se(){m(!0,{record:{id:n.agent.id}})}function re(){d(!0,{record:{id:n.agent.id}})}function ie(t){a("onsend",t),l()}const le=t=>{const o=new FileReader;return o.readAsArrayBuffer(t),o.onload=b=>{var B;if(((B=b.target)==null?void 0:B.result)instanceof ArrayBuffer){const h=new Uint8Array(b.target.result);let A=g.Action.create();A.act="fw",A.path=t.name,A.data=h;let W=g.AgentEvent.create();W.action=A,a("onsend",W),w.success(`\u6587\u4EF6:${t.name} \u5927\u5C0F:${v(t.size)} \u4E0A\u4F20\u4E2D... \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002`)}},o.onerror=()=>{w.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},!1};function de(){let t=n.cmd.split(" "),o=g.Action.create();switch(g.Entry.create(),t[0]){case"ss":o.act="ss";break;case"ps":o.act="ps";break;case"cr":o.act="cr";break;case"cd":o.act="cd",o.path=t[1];break;case"ls":o.act="ls",o.path=t[1];break;case"fr":o.act="fr",o.path=t[1];break;case"fw":const B=atob(t[2]),h=new Uint8Array(B.length);for(let A=0;A<B.length;A++)h[A]=B.charCodeAt(A);o.act="fw",o.path=t[1],o.data=h;break;case"sh":o.act="sh",o.name=btoa(t.slice(1).join(" "));break;case"pl":o.act="pl",o.name=t[1],o.args=t.slice(2).join(" ");break;default:(n.cmd=="?"||n.cmd=="help")&&(u.writeln(""),u.writeln("help/cls  \u5E2E\u52A9/\u6E05\u5C4F ctrl+s \u4FDD\u5B58\u4F1A\u8BDD\u8BB0\u5F55"),u.writeln("sh        \u6267\u884C\u547D\u4EE4 sh cmd"),u.writeln("ls        \u679A\u4E3E\u6587\u4EF6 ls path"),u.writeln("cd        \u5207\u6362\u76EE\u5F55 cd path"),u.writeln("ps        \u67E5\u770B\u8FDB\u7A0B ps"),u.writeln("ss        \u67E5\u770B\u7F51\u7EDC ss"),u.writeln("cr        \u6267\u884C\u622A\u5C4F cr"),u.writeln("fr        \u8BFB\u53D6\u6587\u4EF6 fr path"),u.writeln("fw        \u5199\u5165\u6587\u4EF6 fw path base64"),u.writeln("pl        \u6267\u884C\u63D2\u4EF6 pl name <args>"),u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`)),n.cmd=="cls"&&(u.reset(),u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`)),n.cmd="";return}let b=g.AgentEvent.create();b.action=o,a("onsend",b),u.writeln(n.cmd),w.success(`\u547D\u4EE4:${n.cmd} \u5DF2\u53D1\u9001\uFF01 \u8BF7\u7B49\u5F85\u8FD4\u56DE\u3002`),n.history.push(n.cmd),n.cmd=""}return J(()=>{u.open(p.value),u.loadAddon(f),f.fit(),new ResizeObserver(()=>{f.fit()}).observe(p.value),u.reset()}),Ee(()=>{u.dispose()}),X(()=>{if(e.agent&&n.agent.id!=e.agent.id){n.agent=e.agent;let t=e.agent.process.replaceAll("\\","/").split("/");t.pop(),n.pwd=t.join("/"),u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`)}if(e.event&&(e.event.plugin&&(e.event.plugin.act==="ss"&&e.event.plugin.name==="npc2"&&setTimeout(()=>{n.agent.npc2=!0},5e3),e.event.plugin.act==="dd"&&(u.writeln(e.event.plugin.name,e.event.plugin.args),u.writeln(e.event.plugin.data),u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`))),e.event.action)){switch(u.writeln(""),e.event.action.act){case"cd":n.pwd=e.event.reqcd.path.replaceAll("\\","/"),u.writeln(e.event.action.path);break;case"ls":e.event.action.entrys.map(t=>{var b;const o=t.isfile?"\u{1F4C4}":"\u{1F4C1}";u.writeln(`${o}   ${t.path.padEnd(88)}  ${((b=j(t.modified*1e3))==null?void 0:b.padEnd(20))||"".padEnd(20)} ${v(t.size)}`)});break;case"fw":u.writeln(`\u6587\u4EF6\u5199\u5165\u6210\u529F\uFF01 \u6587\u4EF6\u540D:${e.event.action.path} `);break;case"fr":e.event.action.data.length<=4096?u.writeln(y(e.event.action.data)):u.writeln(`\u6587\u4EF6\u8BFB\u53D6\u6210\u529F\uFF01 \u8BF7\u524D\u5F80\u654F\u611F\u6587\u4EF6\u9879\u4E0B\u8F7D\u6587\u4EF6, \u6587\u4EF6\u5927\u5C0F ${v(e.event.action.data.length)} `);break;case"sh":u.writeln(y(e.event.action.data));break;case"ss":u.writeln(y(e.event.action.data));break;case"ps":u.writeln(y(e.event.action.data));break;case"pl":u.writeln(y(e.event.action.data));break;case"cr":u.writeln(`\u5C4F\u5E55\u622A\u56FE\u6210\u529F\uFF01 \u8BF7\u524D\u5F80\u654F\u611F\u6587\u4EF6\u9879\u67E5\u770B\u622A\u56FE, \u6587\u4EF6\u5927\u5C0F ${v(e.event.action.data.length)} \u3002`);break;case"err":u.writeln(`\u51FA\u9519\u4E86\uFF01 \u9519\u8BEF ${y(e.event.action.data)}`);break}u.write(`[${n.agent.username}@${n.agent.hostname} ${n.pwd}]#`)}}),{state:n,agentinfo:P,terminalRef:p,CmdSend:de,Screen:$,beforeUpload:le,NpcExit:ee,Npc2Load:oe,registerModalproxy:s,registerModalplug:E,CreateProxy:se,RunPlugin:re,PlugSend:ie,OpenCmd:te,OpenFile:ne,OpenVnc:ae,OpenRdp:ue}}}),ze={class:"flex flex-col h-full"},Ve={key:0,class:"mt-2 flex flex-grow-0"},je={class:"terminal-body flex-1 min-h-0"},He={ref:"terminalRef",class:"terminal"};function Ke(e,a,p,n,r,E){const d=F("PopConfirmButton"),l=F("a-button"),s=F("Upload"),m=F("Description"),C=F("CollapseContainer"),w=F("a-input"),P=F("PageWrapper"),f=F("ProxyModal"),u=F("PlugModal");return k(),S(H,null,[i(P,{dense:"",contentFullHeight:"",contentBackground:"",fixedHeight:""},{default:c(()=>[R("div",ze,[i(C,{class:"flex-shrink-0"},{default:c(()=>[e.state.agent.ntype==="npc1"?(k(),S(H,{key:0},[i(d,{disabled:e.state.agent.ntype!=="npc1",title:"\u786E\u5B9A\u9500\u6BC1\u8BE5NPC\u5417?",type:"danger",onConfirm:e.NpcExit},{default:c(()=>[...a[4]||(a[4]=[D("\u9500\u6BC1NPC",-1)])]),_:1},8,["disabled","onConfirm"]),i(s,{"show-upload-list":!1,"before-upload":e.beforeUpload,multiple:!0,disabled:e.state.agent.ntype!=="npc1"},{default:c(()=>[i(l,{type:"primary",disabled:e.state.agent.ntype!=="npc1"},{default:c(()=>[...a[5]||(a[5]=[D("\u4E0A\u4F20\u6587\u4EF6",-1)])]),_:1},8,["disabled"])]),_:1},8,["before-upload","disabled"]),i(l,{onClick:e.Screen,type:"primary",disabled:e.state.agent.ntype!=="npc1"},{default:c(()=>[...a[6]||(a[6]=[D(" \u4E00\u952E\u622A\u5C4F ",-1)])]),_:1},8,["onClick","disabled"]),i(l,{type:"ghost"})],64)):_("",!0),i(d,{type:"danger",title:"\u786E\u5B9A"+(e.state.agent.npc2?"\u5378\u8F7D":"\u52A0\u8F7D")+"NPC2\u5417?",onConfirm:e.Npc2Load},{default:c(()=>[D(be(e.state.agent.npc2?"\u5378\u8F7D":"\u52A0\u8F7D")+"NPC2",1)]),_:1},8,["title","onConfirm"]),i(d,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u6587\u4EF6\u7BA1\u7406\u5417?",type:"primary",onConfirm:a[0]||(a[0]=v=>e.OpenFile(e.state.agent.id))},{default:c(()=>[...a[7]||(a[7]=[D("\u6587\u4EF6\u7BA1\u7406",-1)])]),_:1},8,["disabled"]),i(d,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u865A\u62DF\u7EC8\u7AEF\u5417?",type:"primary",onConfirm:a[1]||(a[1]=v=>e.OpenCmd(e.state.agent.id))},{default:c(()=>[...a[8]||(a[8]=[D("\u865A\u62DF\u7EC8\u7AEF",-1)])]),_:1},8,["disabled"]),i(d,{disabled:!e.state.agent.npc2,title:"\u786E\u5B9A\u6253\u5F00\u865A\u62DF\u684C\u9762\u5417?",type:"primary",onConfirm:a[2]||(a[2]=v=>e.OpenVnc(e.state.agent.id))},{default:c(()=>[...a[9]||(a[9]=[D("\u865A\u62DF\u684C\u9762",-1)])]),_:1},8,["disabled"]),i(l,{onClick:e.CreateProxy,type:"primary",disabled:!e.state.agent.npc2},{default:c(()=>[...a[10]||(a[10]=[D("\u65B0\u5EFA\u96A7\u9053",-1)])]),_:1},8,["onClick","disabled"]),i(l,{type:"ghost"}),e.state.agent.ntype==="npc1"?(k(),U(l,{key:1,onClick:e.RunPlugin,type:"primary"},{default:c(()=>[...a[11]||(a[11]=[D(" \u8FD0\u884C\u63D2\u4EF6 ",-1)])]),_:1},8,["onClick"])):_("",!0),i(m,{onRegister:e.agentinfo,data:e.state.agent},null,8,["onRegister","data"])]),_:1}),e.state.agent.ntype==="npc1"?(k(),S("div",Ve,[i(w,{disabled:e.state.agent.ntype!=="npc1",value:e.state.cmd,"onUpdate:value":a[3]||(a[3]=v=>e.state.cmd=v),onPressEnter:e.CmdSend,placeholder:"\u8F93\u5165help\u67E5\u770B\u5E2E\u52A9",autocomplete:"on"},{addonBefore:c(()=>[...a[12]||(a[12]=[D("\u8F93\u5165\u547D\u4EE4\uFF1A ",-1)])]),_:1},8,["disabled","value","onPressEnter"]),i(l,{type:"danger",onClick:e.CmdSend,disabled:e.state.agent.ntype!=="npc1"},{default:c(()=>[...a[13]||(a[13]=[D("\u53D1\u9001",-1)])]),_:1},8,["onClick","disabled"])])):_("",!0),R("div",je,[R("div",He,null,512)])])]),_:1}),i(f,{onRegister:e.registerModalproxy},null,8,["onRegister"]),i(u,{onRegister:e.registerModalplug,onSuccess:e.PlugSend},null,8,["onRegister","onSuccess"])],64)}var qe=I(We,[["render",Ke],["__scopeId","data-v-d11651da"]]);const Le=O({name:"AgentWork",components:{PageWrapper:Q,PopConfirmButton:Y,Tabs:K,TabPane:K.TabPane,AgentInfo:qe},setup(){const{currentRoute:e}=ve(),a=Be(()=>M(e).params),{closeCurrent:p,setTitle:n}=De(),r=x({uid:ke(),agent:{},event:{}}),{apiUrl:E="/manjusaka"}=we(),d=(window.location.protocol==="https:"?"wss:":"ws:")+"//"+window.location.host+E+"/webproxy/log/"+r.uid,{data:l,send:s,close:m}=ye(d,{autoReconnect:!1,heartbeat:!1});function C(){m(),p()}function w(f){if(f&&r.agent.id){f.id=r.uid,f.sendto=r.agent.id;let v=g.AgentEvent.verify(f);if(v)throw Error(v);var u=g.AgentEvent.encode(f).finish();let y="";for(let $=0;$<u.length;$++)y+=String.fromCharCode(u[$]);T({action:"addevent",data:{id:r.agent.id,data:btoa(y)}})}}function P(){T({action:"agentinfo",data:{id:M(a).id}}).then(f=>{r.agent=f,n("\u5DE5\u4F5C\u53F0 - "+r.agent.username+"@"+r.agent.intranet)}).catch(()=>{})}return X(()=>{if(l.value)try{l.value.arrayBuffer().then(f=>new Uint8Array(f)).then(f=>{let u=g.AgentEvent.decode(f);r.event=u})}catch(f){}}),J(()=>{P()}),{state:r,CloseWork:C,OnHttpSend:w}}});function Ge(e,a,p,n,r,E){const d=F("AgentInfo"),l=F("TabPane"),s=F("PopConfirmButton"),m=F("Tabs"),C=F("PageWrapper");return k(),U(C,{dense:"",contentFullHeight:"",contentBackground:"",fixedHeight:""},{default:c(()=>[i(m,{size:"small"},{tabBarExtraContent:c(()=>[i(s,{title:"\u786E\u5B9A\u65AD\u5F00\u8FDE\u63A5?",type:"danger",onConfirm:e.CloseWork},{default:c(()=>[...a[0]||(a[0]=[D("\u65AD\u5F00\u8FDE\u63A5",-1)])]),_:1},8,["onConfirm"])]),default:c(()=>[i(l,{tab:"NPC\u8BE6\u60C5",key:"1",closable:!0},{default:c(()=>[i(d,{agent:e.state.agent,event:e.state.event,onOnsend:e.OnHttpSend},null,8,["agent","event","onOnsend"])]),_:1})]),_:1})]),_:1})}var vt=I(Le,[["render",Ge]]);export{vt as default};
